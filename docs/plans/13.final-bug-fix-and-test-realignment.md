# Plan: Final Bug Fix & Test Realignment

**Date:** July 14, 2025

## 1. Problem Statement

Despite multiple fixes to the database schema and frontend logic, core functionalities like board creation are still failing with a `Foreign key constraint violated` error. This indicates a fundamental bug in the backend's data creation logic.

Furthermore, the project's integration tests have not been updated to reflect the significant schema changes related to data versioning. This has allowed the backend bug to persist through multiple debugging cycles and prevents us from having a reliable measure of the application's stability.

## 2. Root Cause Analysis

1.  **Incorrect Prisma Create Logic:** The primary bug is in how new records are created and linked. The code in `boards.ts`, `lists.ts`, and `cards.ts` uses the `relation: { connect: { ... } }` syntax. This is the incorrect pattern for assigning a foreign key to an existing record. The correct and simpler method is to directly assign the value to the foreign key field (e.g., `userId: 'some-user-id'`). This single mistake is the cause of the persistent "Foreign key constraint violated" errors.

2.  **Stale and Broken Tests:** The integration test suite is out of sync with the current database schema. The tests are likely still trying to create data using the old, non-versioned model and are not validating the new, correct relationships. Running these broken tests is impossible, which has deprived us of a critical tool for catching these backend bugs early.

## 3. Proposed Solution: Test-Driven Correction

We will adopt a test-driven approach to fix this. We will first fix the tests so they align with the schema, and then use those tests to validate our fix of the backend logic.

### **Solution A: Fix Tests First, Then Fix Code (Recommended)**

This is the most robust approach to ensure a stable, long-term fix.

-   **Pros**:
    -   It re-establishes the test suite as a reliable "source of truth" for how the application should behave.
    -   Fixing the tests first forces a deep understanding of the new schema and its implications.
    -   Once the tests are fixed, they can be used to quickly and reliably verify the final code fix.
    -   Prevents future regressions.
-   **Cons**:
    -   Requires more upfront work on the test suite before fixing the visible application bug.

### **Solution B: Fix Code, Then Fix Tests**

This approach would fix the application bug first and then update the tests to match.

-   **Pros**:
    -   May provide a faster immediate fix to the visible bug.
-   **Cons**:
    -   Higher risk of the code fix being incomplete or having unintended side effects.
    -   It treats tests as an afterthought, which is the practice that led to the current situation.
    -   We would be fixing the backend "in the dark" without a reliable way to verify it until the very end.

**Decision:** We will proceed with **Solution A**. The immediate priority is to make our test suite functional again.

## 4. Implementation Steps

### Phase 1: Repair the Integration Test Suite

1.  **Analyze `tests/helpers.ts` and `tests/integration/setup.ts`**:
    -   **Likely Trouble Spot**: The `setup` and `getAuthHeaders` functions likely create test users and JWTs based on the old schema.
    -   **Action**: Update these helper functions to create users and tokens that match the final, versioned `User` model.

2.  **Fix `tests/integration/api.test.ts`**:
    -   **Likely Trouble Spot**: The `beforeAll` block that creates a `Test Board for Details` is likely using the incorrect foreign key assignment. The test that asserts `ACTIVE` items is good, but its setup is probably broken.
    -   **Action**:
        -   Rewrite the board creation logic in the `beforeAll` block to correctly assign the `userId`.
        -   Run `npm run test:integration` and fix any assertion errors until this file passes.

3.  **Fix `tests/integration/cards.test.ts` and `lists.test.ts`**:
    -   **Likely Trouble Spot**: These files almost certainly create test data (boards, lists, cards) using the old, incorrect logic.
    -   **Action**:
        -   Go through each test file and update all `prisma.list.create` and `prisma.card.create` calls to use direct foreign key assignment.
        -   Update the tests for the `move` endpoints. The assertions should be updated to verify that a *new version* of the item is created with the correct position and that the old version is marked `INACTIVE`.
        -   Run the tests repeatedly and fix all failures.

### Phase 2: Fix the Backend Logic

Once the entire integration test suite is running and **failing predictably** on the known bugs (i.e., the tests for creating and moving items fail because the backend logic is wrong), we can proceed.

1.  **Fix Board Creation (`boards.ts`)**:
    -   **File**: `src/backend/routes/boards.ts`
    -   **Action**: In the `POST /` route, change the `prisma.board.create` call to use `userId: userId` directly, removing the `user: { connect: ... }` block.
    -   **Verification**: Run the integration tests. The board creation tests should now pass.

2.  **Fix List Creation (`boards.ts`)**:
    -   **File**: `src/backend/routes/boards.ts`
    -   **Action**: In the `POST /:boardId/lists` route, change the `prisma.list.create` call to use `boardId: board.boardId` directly.
    -   **Verification**: Run the integration tests. The list creation tests should now pass.

3.  **Fix Card Creation (`lists.ts`)**:
    -   **File**: `src/backend/routes/lists.ts`
    -   **Action**: In the `POST /:id/cards` route, change the `prisma.card.create` call to use `listId: list.listId` directly.
    -   **Verification**: Run the integration tests. The card creation tests should now pass.

4.  **Final Verification**:
    -   Run the entire integration test suite (`npm run test:integration`) one last time to ensure all tests pass.
    -   Perform a final, full manual test of the application.
