# 17. E2E Testing Revamp

## 1. Problem Statement

The existing End-to-End (E2E) tests are outdated and failing consistently due to the integration of Firebase authentication and other significant application changes. Repairing them is inefficient. A fresh start is necessary to build a reliable, maintainable, and scalable E2E test suite.

## 2. Requirements

- **Clean Foundation**: Establish a new, clean E2E testing foundation using Playwright.
- **Robust Authentication**: Implement a best-practice authentication flow that properly handles Firebase user sessions.
- **Initial Smoke Test**: Create a simple "smoke test" to verify that a logged-in user can access the core application page (`/boards`).
- **Scalability**: The new setup should be easily extendable for future tests covering CRUD operations and other user flows.
- **Tooling**: Leverage Playwright's features, such as the test recorder (codegen), to accelerate future test creation.

## 3. Technical Approach

We will adopt Playwright's recommended authentication pattern, which uses a global setup file to handle login once for the entire test run. This isolates the authentication logic from the tests, making them faster, more reliable, and easier to maintain.

1.  **Backup Strategy**: The current `tests/e2e` directory will be renamed to `tests/e2e_backup` to preserve the existing tests for historical reference without interfering with the new suite.
2.  **Global Authentication Setup**: We will use `tests/e2e/auth.setup.ts` as a dedicated setup project in `playwright.config.ts`. This script will:
    - Programmatically create a temporary user in Firebase for the test session using the Firebase Admin SDK.
    - Navigate to the login page and perform the login via the UI.
    - Wait for a successful login and redirect.
    - Save the authenticated browser state (cookies, local storage, etc.) to a file: `playwright/.auth/user.json`.
    - Immediately delete the temporary user from Firebase, as their purpose was only to establish an authenticated session.
3.  **Test Execution**: All subsequent E2E tests will be configured to use the saved `storageState`. This makes the browser start each test as if it were already logged in, completely bypassing the UI login flow for every test file.
4.  **Firebase Utilities**: The helper functions `createUser` and `deleteUser` located in `tests/test-utils.ts` will continue to be used to abstract the Firebase Admin SDK interactions.

## 4. Implementation Steps

1.  **Backup Directory**: Rename the `tests/e2e` directory to `tests/e2e_backup`.
2.  **Create New Directory**: Create a new, empty `tests/e2e` directory.
3.  **Relocate Auth Setup**: Move the existing `auth.setup.ts` from the backup folder into the new `tests/e2e` directory.
4.  **Create Smoke Test**: Create the first new test file, `tests/e2e/smoke.spec.ts`. This test will:
    - Assume the user is already logged in.
    - Navigate directly to the `/boards` page.
    - Assert that the main heading (e.g., "My Boards") is visible.
5.  **Run and Verify**: Execute the Playwright test suite to confirm that the authentication setup runs successfully and the smoke test passes.
6.  **Create Basic User Flow Test**: Implement `tests/e2e/test_user.basics.spec.ts` which uses a persistent, seeded user (`test@example.com`) to perform a series of checks, including login, profile page validation, and board page validation.

## 5. Testing Strategy

- **Smoke Test First**: Validate the authentication and basic application load using the dynamic user created by `auth.setup.ts`.
- **Basic User Flow Test**: A comprehensive test (`test_user.basics.spec.ts`) validates the core application flow for a known, persistent user. This test is ideal for local development and serves as a more robust smoke test.
- **CI/CD Authentication**: The global `auth.setup.ts` provides a clean, isolated user for each test run in automated environments, ensuring no state is carried over between runs.
- **Incremental Additions**: Add new E2E tests for one user flow at a time (e.g., Create Board, Edit Board, Delete Board).
- **Use Codegen**: Use the Playwright test recorder (`npx playwright codegen`) to bootstrap the initial structure of new tests, then refine them manually for clarity and robustness.

## 6. Risks & Mitigation

- **Firebase Credentials**: The Firebase Admin SDK requires a service account key, which is a sensitive secret.
  - **Mitigation**: This key must be managed via environment variables (`.env` file, which is git-ignored) and securely stored in CI/CD environments. It should never be committed to the repository.
- **Flaky Tests**: E2E tests can sometimes be flaky due to timing issues.
  - **Mitigation**: Use Playwright's web-first assertions and auto-waiting mechanisms to build resilient tests. Avoid fixed delays (`waitForTimeout`).

## 7. Dependencies

- Playwright
- Firebase Admin SDK
- TypeScript
